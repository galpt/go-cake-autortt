#!/bin/sh /etc/rc.common
# cake-autortt - automatically adjusts CAKE qdisc RTT parameter
# based on measured RTT to active network connections (Go version)

START=99
USE_PROCD=1

PROG="/usr/bin/cake-autortt"
CONF="/etc/cake-autortt.yaml"

validate_config() {
	# Check if tc is available
	command -v tc >/dev/null 2>&1 || {
		echo "ERROR: tc (traffic control) is required but not installed"
		logger -t cake-autortt "ERROR: tc (traffic control) is required but not installed"
		return 1
	}
	
	# Check if config file exists
	if [ ! -f "$CONF" ]; then
		echo "ERROR: Configuration file $CONF not found"
		logger -t cake-autortt "ERROR: Configuration file $CONF not found"
		return 1
	fi
	
	# Check if binary exists and is executable
	if [ ! -x "$PROG" ]; then
		echo "ERROR: Binary $PROG not found or not executable"
		logger -t cake-autortt "ERROR: Binary $PROG not found or not executable"
		return 1
	fi
	
	# Test if binary can run (basic syntax check)
	"$PROG" --help >/dev/null 2>&1 || {
		echo "ERROR: Binary $PROG failed basic execution test"
		logger -t cake-autortt "ERROR: Binary $PROG failed basic execution test"
		return 1
	}
	
	return 0
}

start_service() {
	validate_config || return 1
	
	logger -t cake-autortt "Starting cake-autortt service with config: $CONF"
	echo "Starting cake-autortt with config: $CONF"
	
	procd_open_instance
	procd_set_param command "$PROG"
	procd_append_param command --config "$CONF"
	
	procd_set_param pidfile /var/run/cake-autortt.pid
	procd_set_param stdout 1
	procd_set_param stderr 1
	
	# Set proper respawn parameters for a long-running service
	procd_set_param respawn ${respawn_threshold:-3600} ${respawn_timeout:-5} ${respawn_retry:-5}
	
	# Set the service to run in foreground mode (required for procd)
	procd_set_param term_timeout 15
	
	# Set working directory and environment
	procd_set_param env HOME=/root
	procd_set_param env PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
	procd_set_param env USER=root
	
	# Enable file limits for the service
	procd_set_param limits nofile="1024 1024"
	
	procd_close_instance
	logger -t cake-autortt "cake-autortt service started"
}

stop_service() {
	echo "Stopping cake-autortt"
	logger -t cake-autortt "Stopping cake-autortt service"
}

reload_service() {
	stop
	start
}

service_triggers() {
	procd_add_reload_trigger "cake-autortt"
}